
@page "/Users"
@inject HttpClient Http

<h3>Users</h3>

<table style="width:100%">
    <tbody>
        <tr>
            <td>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">User Id</th>
                            <th scope="col">First Name</th>
                            <th scope="col">Last Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone Number</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in users.Skip(PageItemCount * CurrentPageId - 1).Take(PageItemCount))
                        {
                            <tr>
                                <td scope="row">@user.UserId</td>
                                <td scope="row">@user.FirstName</td>
                                <td scope="row">@user.LastName</td>
                                <td scope="row">@user.Email</td>
                                <td scope="row">@user.PhoneNumber</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </td>
        </tr>
        <tr>
            <td>
                <BookStore.Web.Client.Components.Pagination ItemsCount="@users.Count" @bind-CurrentPageId="CurrentPageId" @bind-PageItemCount="PageItemCount">

                </BookStore.Web.Client.Components.Pagination>
            </td>
        </tr>
        <tr>
            <td><button @onclick="OpenAddWindow" class="btn btn-outline-secondary">Add user</button></td>
        </tr>
    </tbody>
</table>

<BookStore.Web.Client.Components.LoadWindow Show="IsShowLoadWindow">

</BookStore.Web.Client.Components.LoadWindow>

<BookStore.Web.Client.Components.ModalWindow Show="@OpenAddModal">
    <EditForm Model="user" OnValidSubmit="@Submit">
        <DataAnnotationsValidator />
        @*<ValidationSummary />*@

        <div class="modal-header form-group without-padding">
            <h5 class="modal-title">User adding</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" @onclick="HideAddWindow">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="form-group">
            <label>User Id</label>
            <InputText class="form-control" @bind-Value="user.UserId" @onfocusout="CheckUserId" />
            <span hidden="@(!UserWithUserIdExists)" class="validation-message">User with UserId @user?.UserId alredy exists</span>
            <ValidationMessage hidden="@UserWithUserIdExists" For="() => user.UserId" />
        </div>

        <div class="form-group">
            <label>User Role</label>
            <select class="form-control" @bind="user.UserRoleId">
                <option value="-1" selected>-- select user role --</option>
                @foreach (var userRole in userRoles)
                {
                    <option value="@userRole.Id">@userRole.Name</option>
                }
            </select>
            <ValidationMessage For="() => user.UserRoleId" />
        </div>

        <div class="form-group">
            <label>First Name</label>
            <InputText class="form-control" @bind-Value="user.FirstName" />
            <ValidationMessage For="() => user.FirstName" />
        </div>
        <div class="form-group">
            <label>Last Name</label>
            <InputText class="form-control" @bind-Value="user.LastName" />
            <ValidationMessage For="() => user.LastName" />
        </div>
        <div class="form-group">
            <label>Email</label>
            <InputText class="form-control" @bind-Value="user.Email" />
            <ValidationMessage For="() => user.Email" />
        </div>
        <div class="form-group">
            <label>Phone number</label>
            <InputText class="form-control" @bind-Value="user.PhoneNumber" />
            <ValidationMessage For="() => user.PhoneNumber" />
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Confirm</button>
        </div>
    </EditForm>

</BookStore.Web.Client.Components.ModalWindow>

@code
{
    private User user = new User();

    private List<User> users = new List<User>();
    private List<UserRole> userRoles = new List<UserRole>();

    private bool OpenAddModal { get; set; }

    private bool UserWithUserIdExists;

    private bool IsShowLoadWindow { get; set; }

    private int CurrentPageId { get; set; } = 0;
    private int PageItemCount { get; set; } = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    protected void OpenAddWindow()
    {
        this.OpenAddModal = true;
    }

    private void HideAddWindow()
    {
        user = new User();
        this.OpenAddModal = true;
    }

    private async Task LoadUsers()
    {
        this.IsShowLoadWindow = true;
        users = await Http.GetFromJsonAsync<List<User>>("User");
        userRoles = await Http.GetFromJsonAsync<List<UserRole>>("User/Roles");
        this.IsShowLoadWindow = false;
    }


    private async Task AddUser()
    {
        await Http.PostAsJsonAsync("User", user);
    }

    protected void CheckUserId()
    {
        if (!string.IsNullOrEmpty(user?.UserId))
        {
            UserWithUserIdExists = users.Any(x => x.UserId.Trim().ToUpperInvariant() == user.UserId.Trim().ToUpperInvariant());
        }
    }

    protected async Task Submit()
    {
        CheckUserId();
        if (UserWithUserIdExists)
        {
            return;
        }
        await AddUser();
        await LoadUsers();
        this.OpenAddModal = false;
    }
}
